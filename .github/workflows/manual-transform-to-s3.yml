# 
# 1. Download data from faostat
# 2. Load into postgres
# 3. Transform
# 4. Export to S3, for easy importing on-demand

name: faostat-transform-to-s3

on:
  workflow_dispatch:

permissions:
  id-token: write # required for aws oidc access

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::779071549559:role/aws-github-oidc-foodbrowser
        role-session-name: foodbrowser-write-to-s3-role-session
        aws-region: eu-west-1
    - name: Upload to S3
      run: |
        echo "test" > /tmp/test.txt
        aws s3 cp /tmp/test.txt s3://foodbrowser/test.txt
    - name: Download faostat, import into postgres and transform
      run: |
        cd etl/postgresql
        time bash -x import.sh

